version: 2.1
parameters:
  application:
    type: boolean
    default: false
  bastion:
    type: boolean
    default: false
  database:
    type: boolean
    default: false
  main:
    type: boolean
    default: false
  network:
    type: boolean
    default: false
  secrets:
    type: boolean
    default: false
jobs:
  terraform-init:
    docker:
      - image: "alpine:3.14.1"
    parameters:
      project_path:
        type: string
    steps:
    - checkout
    - run:
        name: Terraform Install
        command: |
          wget https://releases.hashicorp.com/terraform/0.15.1/terraform_0.15.1_linux_amd64.zip
          unzip terraform_0.15.1_linux_amd64.zip -d /bin
    - run:
        name: Terraform Init
        command: |
          cd << parameters.project_path >>
          for i in $(echo $ACCOUNTS | sed "s/,/ /g")
          do
              echo "$i"
              ls
          done
          mkdir -p .terraform/
          touch .terraform/test
    - save_cache:
        key: terraform-state
        paths:
          - .terraform/
  terraform-apply:
    docker:
      - image: "alpine:3.14.1"
    parameters:
      project_path:
        type: string
    steps:
    - checkout
    - run:
        name: Terraform Install
        command: |
          wget https://releases.hashicorp.com/terraform/0.15.1/terraform_0.15.1_linux_amd64.zip
          unzip terraform_0.15.1_linux_amd64.zip -d /bin
    - restore_cache:
        keys: terraform-state
    - run:
        name: Terraform Apply
        command: |
          cd << parameters.project_path >>
          ls /tmp
          for i in $(echo $ACCOUNTS | sed "s/,/ /g")
          do
              echo "$i"
              ls
          done
workflows:
  application:
    jobs:
      - terraform-init:
          name: terrorm-init-application
          project_path: chaoskube
      - terraform-apply:
          name: terrorm-init-main
          project_path: chaoskube
          requires:
            - terrorm-init-application
